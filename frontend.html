<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard Quiz App</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="root" class="container mx-auto p-4"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- API Utility ---
        // A helper function to make API calls, handling authentication
        const api = {
            // We store the token in a global variable for simplicity
            _token: null,

            async get(endpoint) {
                const response = await fetch(`http://127.0.0.1:8000/api${endpoint}`, {
                    headers: { 'Authorization': `Token ${this._token}` }
                });
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            },

            async post(endpoint, data) {
                const response = await fetch(`http://127.0.0.1:8000/api${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Token ${this._token}`
                    },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(JSON.stringify(errorData));
                }
                return response.json();
            },

            async login(username, password) {
                // Note: Django REST Framework's default token auth is not a standard endpoint.
                // We'll use a simple workaround for this tutorial. A better approach is JWT.
                // For now, we assume you have a way to get a token. We'll simulate it.
                // The proper way is to set up a dedicated /api/token/ endpoint.
                // For this example, we'll use a placeholder.
                // In a real app, you'd POST to an auth endpoint.
                // Let's use the 'api-auth/login/' for now, which is session-based.
                // For token auth, you'd typically need a custom endpoint or a library like djoser.

                // This is a simplified login. For a real app, use a dedicated token auth library.
                // We will hardcode a token for now. Go to your Django admin, find your user,
                // and you can manually create a token for them via the DRF Token admin interface.
                // Or, use the shell:
                // python manage.py drf_create_token <username>
                console.warn("Using a placeholder login. Replace with a real token auth flow.");
            }
        };

        // --- Components ---
        // Login Form Component
        function LoginForm({ onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [token, setToken] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!token) {
                    setError('Please generate a token and paste it here.');
                    return;
                }
                api._token = token;
                onLogin(token);
            };

            return (
                <div className="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md">
                    <h2 className="text-2xl font-bold mb-6 text-center">Login</h2>
                    <p className="text-sm text-gray-600 mb-4 text-center">
                        This app uses Token Authentication. Please generate a token for your user.
                        <br/>
                        Run this in your terminal: <br/>
                        <code className="bg-gray-200 p-1 rounded">python manage.py drf_create_token your_username</code>
                        <br/>
                        Then paste the token below.
                    </p>
                    <form onSubmit={handleSubmit}>
                        <div className="mb-4">
                            <label className="block text-gray-700 mb-2" htmlFor="token">Auth Token</label>
                            <input
                                id="token"
                                type="text"
                                value={token}
                                onChange={(e) => setToken(e.target.value)}
                                className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Paste your token here"
                            />
                        </div>
                        {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
                        <button type="submit" className="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            Set Token & Login
                        </button>
                    </form>
                </div>
            );
        }
        // Main Application Component
        function App() {
            const [token, setToken] = useState(null);
            const [decks, setDecks] = useState([]);
            const [selectedDeck, setSelectedDeck] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => {
                if (token) {
                    fetchDecks();
                }
            }, [token]);

            const fetchDecks = async () => {
                setLoading(true);
                setError('');
                try {
                    const data = await api.get('/decks/');
                    setDecks(data.results || data); // Handle pagination from DRF
                } catch (err) {
                    setError('Failed to fetch decks. Is your Django server running and CORS configured?');
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            const handleDeckCreated = (newDeck) => {
                setDecks([...decks, newDeck]);
            };

            if (!token) {
                return <LoginForm onLogin={setToken} />;
            }

            if (selectedDeck) {
                return <DeckDetail deck={selectedDeck} onBack={() => setSelectedDeck(null)} />;
            }

            return (
                <div className="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-md">
                    <h1 className="text-3xl font-bold mb-6">Your Decks</h1>
                    {loading && <p>Loading...</p>}
                    {error && <p className="text-red-500">{error}</p>}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                        {decks.map(deck => (
                            <div
                                key={deck.id}
                                className="bg-gray-50 p-4 rounded-lg shadow cursor-pointer hover:shadow-lg hover:bg-blue-50 transition-all"
                                onClick={() => setSelectedDeck(deck)}
                            >
                                <h3 className="font-bold text-lg text-blue-700">{deck.name}</h3>
                                <p className="text-gray-600 text-sm">{deck.description}</p>
                                <p className="text-gray-500 text-xs mt-2">{deck.cards.length} cards</p>
                            </div>
                        ))}
                    </div>
                    <AddDeckForm onDeckCreated={handleDeckCreated} />
                </div>
            );
        }
        // Component to show details of a single deck and its cards
        function DeckDetail({ deck, onBack }) {
            const [cards, setCards] = useState(deck.cards || []);

            const handleCardCreated = (newCard) => {
                setCards([...cards, newCard]);
            };

            return (
                <div className="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-md">
                    <button onClick={onBack} className="bg-gray-200 text-gray-800 py-1 px-3 rounded-lg hover:bg-gray-300 mb-4">&larr; Back to Decks</button>
                    <h2 className="text-3xl font-bold mb-2">{deck.name}</h2>
                    <p className="text-gray-600 mb-6">{deck.description}</p>

                    <h3 className="text-2xl font-semibold mb-4">Cards</h3>
                     <div className="space-y-4 mb-8">
                        {cards.map(card => (
                            <div key={card.id} className="bg-gray-50 p-4 rounded-lg shadow-sm">
                                <p className="font-semibold">Q: {card.question}</p>
                                <p className="text-gray-700">A: {card.answer}</p>
                            </div>
                        ))}
                        {cards.length === 0 && <p className="text-gray-500">No cards in this deck yet.</p>}
                    </div>

                    <AddCardForm deckId={deck.id} onCardCreated={handleCardCreated} />
                </div>
            )
        }

        // Form to add a new deck
        function AddDeckForm({ onDeckCreated }) {
            const [name, setName] = useState('');
            const [description, setDescription] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    const newDeck = await api.post('/decks/', { name, description });
                    onDeckCreated(newDeck);
                    setName('');
                    setDescription('');
                } catch (error) {
                    console.error("Failed to create deck:", error);
                    alert("Error creating deck. Check console for details.");
                }
            };

            return (
                <div className="mt-8 pt-6 border-t">
                    <h3 className="text-2xl font-semibold mb-4">Create a New Deck</h3>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="Deck Name" required className="w-full px-3 py-2 border rounded-lg"/>
                        <textarea value={description} onChange={e => setDescription(e.target.value)} placeholder="Description" className="w-full px-3 py-2 border rounded-lg"/>
                        <button type="submit" className="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600">Create Deck</button>
                    </form>
                </div>
            );
        }

        // Form to add a new card to a deck
        function AddCardForm({ deckId, onCardCreated }) {
            const [question, setQuestion] = useState('');
            const [answer, setAnswer] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    const newCard = await api.post('/cards/', { question, answer, deck: deckId });
                    onCardCreated(newCard);
                    setQuestion('');
                    setAnswer('');
                } catch (error) {
                    console.error("Failed to create card:", error);
                    alert("Error creating card. Check console for details.");
                }
            };

            return (
                <div className="mt-8 pt-6 border-t">
                    <h3 className="text-2xl font-semibold mb-4">Add a New Card</h3>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <textarea value={question} onChange={e => setQuestion(e.target.value)} placeholder="Question" required className="w-full px-3 py-2 border rounded-lg"/>
                        <textarea value={answer} onChange={e => setAnswer(e.target.value)} placeholder="Answer" required className="w-full px-3 py-2 border rounded-lg"/>
                        <button type="submit" className="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600">Add Card</button>
                    </form>
                </div>
            );
        }


        // Render the main App component into the #root div
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>

</body>
</html>